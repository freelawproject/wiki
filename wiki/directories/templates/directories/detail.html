{% extends "base.html" %}
{% load static %}

{% block title %}{{ directory.title|default:"Home" }} - FLP Wiki{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/highlight.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-3xl">
  {# Breadcrumbs #}
  <nav class="breadcrumbs mb-5">
    {% for title, url in breadcrumbs %}
      {% if not forloop.last %}
        <a href="{{ url }}">{{ title }}</a>
        <span class="separator">/</span>
      {% else %}
        <span class="current">{{ title }}</span>
      {% endif %}
    {% endfor %}
  </nav>

  <div class="flex flex-col xl:flex-row xl:items-center justify-between gap-3 mb-8">
    <h1>
      {{ directory.title|default:"Home" }}
      {% if directory.visibility == "private" %}
        <span class="badge-yellow align-middle ml-2">Private</span>
      {% endif %}
    </h1>
    <div class="flex items-center gap-2 flex-shrink-0">
      {% if user.is_authenticated %}
        {% if directory and directory.path %}
          <a href="{% url 'page_create_in_dir' path=directory.path %}" class="btn-primary text-sm">New Page</a>
        {% else %}
          <a href="{% url 'page_create' %}" class="btn-primary text-sm">New Page</a>
        {% endif %}
      {% endif %}
      {% if can_edit or user.is_authenticated %}
      <div class="relative" x-data="dropdown">
        <button @click="toggle" @click.outside="close" class="btn-outline text-sm" type="button">
          Actions
          <svg class="w-3.5 h-3.5 ml-0.5 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div x-show="open" x-cloak @click="close" class="dropdown-menu">
          {% if can_edit %}
            {% if directory.path %}
              <a href="{% url 'directory_edit' path=directory.path %}" class="dropdown-item">Edit</a>
              <a href="{% url 'directory_permissions' path=directory.path %}" class="dropdown-item">Permissions</a>
              <a href="{% url 'directory_move' path=directory.path %}" class="dropdown-item">Move</a>
              <a href="{% url 'directory_delete' path=directory.path %}" class="dropdown-item-danger">Delete</a>
            {% else %}
              <a href="{% url 'directory_edit_root' %}" class="dropdown-item">Edit</a>
              <a href="{% url 'directory_permissions_root' %}" class="dropdown-item">Permissions</a>
            {% endif %}
          {% endif %}
          {% if directory.path %}
            <a href="{% url 'directory_history' path=directory.path %}" class="dropdown-item">History</a>
          {% else %}
            <a href="{% url 'directory_history_root' %}" class="dropdown-item">History</a>
          {% endif %}
          {% if user.is_authenticated %}
            {% if directory and directory.path %}
              <a href="{% url 'directory_create_in_dir' path=directory.path %}" class="dropdown-item">New Directory</a>
            {% else %}
              <a href="{% url 'directory_create' %}" class="dropdown-item">New Directory</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  {% if rendered_description %}
  <div class="wiki-content mb-8">
    {{ rendered_description|safe }}
  </div>
  {% endif %}

  {# Subdirectories #}
  {% if subdirectories %}
  <h2 class="text-lg font-semibold font-sans mb-3">Directories</h2>
  <div class="grid gap-2 mb-8">
    {% for subdir in subdirectories %}
    <a href="{{ subdir.get_absolute_url }}" class="card flex items-center gap-3 py-3.5 px-5 hover:shadow-card-hover hover:border-primary-300 dark:hover:border-primary-600 transition-all no-underline">
      <svg class="w-5 h-5 text-primary-400 dark:text-primary-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
      </svg>
      <span class="font-medium text-gray-900 dark:text-gray-100">{{ subdir.title }}</span>
    </a>
    {% endfor %}
  </div>
  {% endif %}

  {# Pages #}
  {% if pages %}
  {# Sort controls #}
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg font-semibold font-sans">Pages</h2>
    <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
      <span class="text-gray-400 dark:text-gray-500 mr-1">Sort:</span>
      {% if current_sort == "title" %}<strong class="text-gray-900 dark:text-gray-100">Title</strong>{% else %}<a href="?sort=title" class="hover:underline">Title</a>{% endif %}
      <span class="text-gray-300 dark:text-gray-600">|</span>
      {% if current_sort == "updated" %}<strong class="text-gray-900 dark:text-gray-100">Last edited</strong>{% else %}<a href="?sort=updated" class="hover:underline">Last edited</a>{% endif %}
      <span class="text-gray-300 dark:text-gray-600">|</span>
      {% if current_sort == "created" %}<strong class="text-gray-900 dark:text-gray-100">Created</strong>{% else %}<a href="?sort=created" class="hover:underline">Created</a>{% endif %}
      <span class="text-gray-300 dark:text-gray-600">|</span>
      {% if current_sort == "views" %}<strong class="text-gray-900 dark:text-gray-100">Most viewed</strong>{% else %}<a href="?sort=views" class="hover:underline">Most viewed</a>{% endif %}
    </div>
  </div>
  <div class="grid gap-2">
    {% for page in pages %}
    <a href="{{ page.get_absolute_url }}" class="card flex items-center gap-3 py-3.5 px-5 hover:shadow-card-hover hover:border-primary-300 dark:hover:border-primary-600 transition-all no-underline">
      <svg class="w-5 h-5 text-gray-400 dark:text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
      </svg>
      <div class="flex-1 min-w-0">
        <span class="font-medium text-gray-900 dark:text-gray-100">{{ page.title }}</span>
        <span class="text-sm text-gray-400 dark:text-gray-500 ml-2">
          {{ page.updated_at|timesince }} ago
        </span>
      </div>
    </a>
    {% endfor %}
  </div>
  {% endif %}

  {% if not subdirectories and not pages %}
  <div class="text-center py-12">
    <svg class="w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
    </svg>
    <p class="text-gray-500 dark:text-gray-400">
      This directory is empty.
      {% if user.is_authenticated %}
        {% if directory and directory.path %}
          <a href="{% url 'page_create_in_dir' path=directory.path %}">Create the first page</a>.
        {% else %}
          <a href="{% url 'page_create' %}">Create the first page</a>.
        {% endif %}
      {% endif %}
    </p>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block footer_scripts %}
<script src="{% static 'js/highlight.min.js' %}"></script>
<script src="{% static 'js/code-blocks.js' %}"></script>
{% endblock %}
